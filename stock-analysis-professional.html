<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Professional Stock Analysis - AI-Powered Financial Analysis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f2e 100%);
      color: white;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container { max-width: 1800px; margin: 0 auto; }
    
    .header {
      text-align: center;
      padding: 50px 20px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(46, 213, 115, 0.1));
      border-radius: 24px;
      border: 2px solid rgba(102, 126, 234, 0.3);
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 3rem;
      background: linear-gradient(135deg, #667eea, #2ed573);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 15px;
    }
    
    .badge {
      display: inline-block;
      background: linear-gradient(135deg, #2ed573, #26d0ce);
      padding: 10px 25px;
      border-radius: 20px;
      font-weight: 700;
      margin: 5px;
      font-size: 0.9rem;
    }
    
    .search-section {
      background: rgba(0,0,0,0.3);
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 30px;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    .search-box {
      position: relative;
      display: flex;
      gap: 15px;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .search-box input {
      flex: 1;
      padding: 20px 30px;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(102, 126, 234, 0.3);
      border-radius: 15px;
      color: white;
      font-size: 1.3rem;
    }
    
    .btn {
      padding: 20px 40px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 15px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1.1rem;
      transition: all 0.3s;
    }
    
    .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5); }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .overview-card {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.05));
      border-radius: 24px;
      padding: 40px;
      margin-bottom: 30px;
      border: 2px solid rgba(102, 126, 234, 0.3);
    }
    
    .stock-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .stock-symbol {
      font-size: 3rem;
      font-weight: 800;
      color: #a8b2d1;
    }
    
    .stock-name {
      font-size: 1.3rem;
      color: rgba(255,255,255,0.6);
      margin-top: 5px;
    }
    
    .price-display .current-price {
      font-size: 3.5rem;
      font-weight: 700;
      color: #667eea;
    }
    
    .price-change {
      font-size: 1.5rem;
      margin-top: 10px;
      font-weight: 600;
    }
    
    .positive { color: #2ed573; }
    .negative { color: #ff6b6b; }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    
    .metric-box {
      background: rgba(0,0,0,0.3);
      padding: 25px;
      border-radius: 14px;
      border: 1px solid rgba(102, 126, 234, 0.2);
      text-align: center;
    }
    
    .metric-label {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 10px;
    }
    
    .metric-value {
      font-size: 1.6rem;
      font-weight: 700;
      color: #a8b2d1;
    }
    
    .analysis-section {
      background: rgba(0,0,0,0.3);
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 30px;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    .section-title {
      font-size: 1.8rem;
      color: #667eea;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .analysis-content {
      background: rgba(255,255,255,0.03);
      padding: 30px;
      border-radius: 12px;
      border-left: 4px solid #667eea;
      line-height: 1.8;
      font-size: 1.05rem;
    }
    
    .analysis-content h3 {
      color: #2ed573;
      margin: 25px 0 15px 0;
      font-size: 1.3rem;
    }
    
    .analysis-content h4 {
      color: #a8b2d1;
      margin: 20px 0 10px 0;
      font-size: 1.1rem;
    }
    
    .analysis-content ul {
      margin-left: 25px;
      margin-top: 10px;
    }
    
    .analysis-content li {
      margin: 8px 0;
    }
    
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 30px;
      margin-top: 30px;
    }
    
    .chart-card {
      background: rgba(255,255,255,0.03);
      padding: 25px;
      border-radius: 14px;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    .chart-title {
      font-size: 1.2rem;
      color: #a8b2d1;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .chart-container {
      position: relative;
      height: 350px;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .data-table th,
    .data-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid rgba(102, 126, 234, 0.1);
    }
    
    .data-table th {
      background: rgba(102, 126, 234, 0.15);
      color: #a8b2d1;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.9rem;
    }
    
    .data-table td {
      color: rgba(255,255,255,0.85);
    }
    
    .data-table tr:hover {
      background: rgba(102, 126, 234, 0.05);
    }
    
    .highlight-box {
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.1), rgba(102, 126, 234, 0.05));
      border-left: 4px solid #2ed573;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .warning-box {
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 159, 67, 0.05));
      border-left: 4px solid #ff6b6b;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .loading {
      text-align: center;
      padding: 100px 20px;
    }
    
    .spinner {
      display: inline-block;
      width: 70px;
      height: 70px;
      border: 7px solid rgba(102, 126, 234, 0.2);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .error-box {
      background: rgba(255, 107, 107, 0.15);
      border: 2px solid #ff6b6b;
      border-radius: 15px;
      padding: 30px;
      color: #ff6b6b;
      margin: 20px 0;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 15px 25px;
      background: rgba(255,255,255,0.03);
      border: none;
      border-bottom: 3px solid transparent;
      color: rgba(255,255,255,0.6);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .tab:hover, .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @media (max-width: 768px) {
      .chart-grid { grid-template-columns: 1fr; }
      .stock-header { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üéØ Professional Stock Analysis</h1>
      <p style="font-size: 1.2rem; color: rgba(255,255,255,0.8); margin: 15px 0;">
        AI-Powered Financial Analysis ‚Ä¢ DCF Valuation ‚Ä¢ Growth Trends ‚Ä¢ Debt Profiling
      </p>
      <div>
        <span class="badge">‚úÖ Works for ANY Stock</span>
        <span class="badge">ü§ñ AI Analysis</span>
        <span class="badge">üìä Professional Charts</span>
        <span class="badge">üí∞ DCF Models</span>
      </div>
    </div>

    <!-- Search -->
    <div class="search-section">
      <h2 style="text-align: center; margin-bottom: 25px; color: #a8b2d1; font-size: 1.8rem;">
        üîç Analyze Any Stock - Powered by AI
      </h2>
      <div class="search-box">
        <input 
          type="text" 
          id="symbolInput" 
          placeholder="Enter stock ticker (AAPL, BABA, TSLA, GOOGL...)..." 
          oninput="showSuggestions()"
          onfocus="showSuggestions()"
          onblur="hideSuggestionsDelayed()"
          onkeypress="if(event.key==='Enter') analyzeStock()"
        >
        <div id="suggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 200px; background: rgba(10, 14, 39, 0.98); border: 2px solid rgba(102, 126, 234, 0.4); border-top: none; border-radius: 0 0 15px 15px; max-height: 400px; overflow-y: auto; z-index: 1000; box-shadow: 0 10px 40px rgba(0,0,0,0.5);"></div>
        <button class="btn" onclick="analyzeStock()" id="analyzeBtn">
          üöÄ Analyze Stock
        </button>
      </div>
      <p style="text-align: center; margin-top: 20px; color: rgba(255,255,255,0.5); font-size: 0.9rem;">
        üí° Cached stocks load instantly ‚Ä¢ New tickers analyzed in ~10 seconds
      </p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
      <!-- Overview Card -->
      <div class="overview-card">
        <div class="stock-header">
          <div>
            <div class="stock-symbol" id="stockSymbol"></div>
            <div class="stock-name" id="stockName"></div>
            <div style="margin-top: 8px; color: rgba(255,255,255,0.5);" id="stockInfo"></div>
          </div>
          <div class="price-display">
            <div class="current-price" id="currentPrice"></div>
            <div class="price-change" id="priceChange"></div>
          </div>
        </div>
        <div class="metrics-grid" id="metricsGrid"></div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('ai-analysis')">ü§ñ AI Analysis</button>
        <button class="tab" onclick="switchTab('dcf')">üí∞ DCF Valuation</button>
        <button class="tab" onclick="switchTab('growth')">üìà Growth & Margins</button>
        <button class="tab" onclick="switchTab('debt')">üí≥ Debt Profile</button>
        <button class="tab" onclick="switchTab('roe')">üéØ ROE Analysis</button>
        <button class="tab" onclick="switchTab('charts')">üìä Charts</button>
      </div>

      <!-- AI Analysis Tab -->
      <div id="ai-analysis-tab" class="tab-content active">
        <div class="analysis-section">
          <div class="section-title">ü§ñ AI-Powered Financial Analysis</div>
          <div id="aiAnalysisContent" class="analysis-content">
            <p style="color: rgba(255,255,255,0.6);">
              Click "Generate AI Analysis" to get a comprehensive report...
            </p>
          </div>
          <button class="btn" onclick="generateAIAnalysis()" id="aiBtn" style="margin-top: 20px;">
            ü§ñ Generate AI Analysis
          </button>
        </div>
      </div>

      <!-- DCF Tab -->
      <div id="dcf-tab" class="tab-content">
        <div class="analysis-section">
          <div class="section-title">üí∞ DCF Valuation Model</div>
          <div id="dcfContent"></div>
        </div>
      </div>

      <!-- Growth Tab -->
      <div id="growth-tab" class="tab-content">
        <div class="analysis-section">
          <div class="section-title">üìà Growth & Margin Analysis</div>
          <div id="growthContent"></div>
        </div>
      </div>

      <!-- Debt Tab -->
      <div id="debt-tab" class="tab-content">
        <div class="analysis-section">
          <div class="section-title">üí≥ Debt Profiling & Credit Analysis</div>
          <div id="debtContent"></div>
        </div>
      </div>

      <!-- ROE Tab -->
      <div id="roe-tab" class="tab-content">
        <div class="analysis-section">
          <div class="section-title">üéØ ROE Decomposition (DuPont Analysis)</div>
          <div id="roeContent"></div>
        </div>
      </div>

      <!-- Charts Tab -->
      <div id="charts-tab" class="tab-content">
        <div class="analysis-section">
          <div class="section-title">üìä Financial Visualizations</div>
          <div class="chart-grid" id="chartsContent"></div>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p style="font-size: 1.3rem; color: #667eea; margin-top: 20px;" id="loadingText">
        Loading comprehensive analysis...
      </p>
    </div>

    <!-- Error -->
    <div id="errorBox"></div>
  </div>

  <script>
    // ==========================================
    // GLOBAL STATE
    // ==========================================
    
    let cachedData = null;
    let currentStock = null;
    let currentSymbol = '';
    
    // Popular stocks list for autocomplete (works even without database)
    const popularTickers = [
      { symbol: 'AAPL', name: 'Apple Inc.' },
      { symbol: 'MSFT', name: 'Microsoft Corporation' },
      { symbol: 'GOOGL', name: 'Alphabet Inc.' },
      { symbol: 'AMZN', name: 'Amazon.com Inc.' },
      { symbol: 'NVDA', name: 'NVIDIA Corporation' },
      { symbol: 'META', name: 'Meta Platforms Inc.' },
      { symbol: 'TSLA', name: 'Tesla Inc.' },
      { symbol: 'NFLX', name: 'Netflix Inc.' },
      { symbol: 'BABA', name: 'Alibaba Group' },
      { symbol: 'BIDU', name: 'Baidu Inc.' },
      { symbol: 'JD', name: 'JD.com Inc.' },
      { symbol: 'NIO', name: 'NIO Inc.' },
      { symbol: 'XPEV', name: 'XPeng Inc.' },
      { symbol: 'PDD', name: 'PDD Holdings' },
      { symbol: 'INFY', name: 'Infosys Limited' },
      { symbol: 'HDB', name: 'HDFC Bank' },
      { symbol: 'JPM', name: 'JPMorgan Chase' },
      { symbol: 'BAC', name: 'Bank of America' },
      { symbol: 'WFC', name: 'Wells Fargo' },
      { symbol: 'GS', name: 'Goldman Sachs' },
      { symbol: 'V', name: 'Visa Inc.' },
      { symbol: 'MA', name: 'Mastercard Inc.' },
      { symbol: 'PYPL', name: 'PayPal Holdings' },
      { symbol: 'VALE', name: 'Vale S.A.' },
      { symbol: 'MELI', name: 'MercadoLibre' },
      { symbol: 'NU', name: 'Nu Holdings' },
      { symbol: 'WMT', name: 'Walmart Inc.' },
      { symbol: 'HD', name: 'Home Depot' },
      { symbol: 'DIS', name: 'Walt Disney' },
      { symbol: 'NKE', name: 'Nike Inc.' },
      { symbol: 'MCD', name: "McDonald's" },
      { symbol: 'SBUX', name: 'Starbucks' },
      { symbol: 'COST', name: 'Costco' },
      { symbol: 'TGT', name: 'Target' },
      { symbol: 'JNJ', name: 'Johnson & Johnson' },
      { symbol: 'UNH', name: 'UnitedHealth' },
      { symbol: 'PFE', name: 'Pfizer Inc.' },
      { symbol: 'SPY', name: 'S&P 500 ETF' },
      { symbol: 'QQQ', name: 'NASDAQ 100 ETF' },
      { symbol: 'DIA', name: 'Dow Jones ETF' }
    ];
    
    function showSuggestions() {
      const input = document.getElementById('symbolInput');
      const query = input.value.trim().toUpperCase();
      const dropdown = document.getElementById('suggestions');
      
      if (query.length === 0) {
        dropdown.style.display = 'none';
        return;
      }
      
      // Get available stocks
      let availableStocks = [];
      
      // If we have cached data, use it
      if (cachedData) {
        availableStocks = Object.keys(cachedData).map(symbol => ({
          symbol: symbol,
          name: cachedData[symbol].name
        }));
      } else {
        // Use popular tickers list
        availableStocks = popularTickers;
      }
      
      // Filter matches
      const matches = availableStocks.filter(stock => 
        stock.symbol.toUpperCase().includes(query) ||
        stock.name.toUpperCase().includes(query)
      ).slice(0, 8);
      
      if (matches.length > 0) {
        dropdown.innerHTML = matches.map(stock => `
          <div style="padding: 15px 20px; cursor: pointer; border-bottom: 1px solid rgba(102, 126, 234, 0.1); transition: all 0.2s;" 
               onmouseover="this.style.background='rgba(102, 126, 234, 0.2)'"
               onmouseout="this.style.background='transparent'"
               onmousedown="selectStock('${stock.symbol}')">
            <div style="font-weight: 700; color: #667eea; font-size: 1.1rem;">${stock.symbol}</div>
            <div style="color: rgba(255,255,255,0.7); font-size: 0.95rem; margin-top: 3px;">${stock.name}</div>
            ${!cachedData ? '<div style="color: #ff9f43; font-size: 0.85rem; margin-top: 5px;">‚ö†Ô∏è Not in database yet</div>' : ''}
          </div>
        `).join('');
        dropdown.style.display = 'block';
      } else {
        dropdown.style.display = 'none';
      }
    }
    
    function selectStock(symbol) {
      document.getElementById('symbolInput').value = symbol;
      document.getElementById('suggestions').style.display = 'none';
      analyzeStock();
    }
    
    function hideSuggestionsDelayed() {
      setTimeout(() => {
        document.getElementById('suggestions').style.display = 'none';
      }, 200);
    }
    
    // ==========================================
    // LOAD CACHED DATA
    // ==========================================
    
    // Popular stocks list for autocomplete (works even without database)
    const popularTickers = [
      'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'META', 'TSLA', 'NFLX',
      'BABA', 'BIDU', 'JD', 'NIO', 'XPEV', 'PDD', 'INFY', 'HDB',
      'JPM', 'BAC', 'WFC', 'GS', 'V', 'MA', 'PYPL', 'VALE', 'MELI', 'NU',
      'WMT', 'HD', 'DIS', 'NKE', 'MCD', 'SBUX', 'COST', 'TGT',
      'JNJ', 'UNH', 'PFE', 'SPY', 'QQQ', 'DIA'
    ];
    
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('üîç Loading stock database...');
      
      try {
        // Try loading with cache-busting parameter
        const timestamp = new Date().getTime();
        const response = await fetch(`stock-analysis-data.json?v=${timestamp}`);
        
        console.log(`üì° Fetch response status: ${response.status}`);
        
        if (response.ok) {
          const data = await response.json();
          
          if (!data.stocks) {
            console.error('‚ùå No stocks object in JSON');
            showDatabaseMissingWarning();
            return;
          }
          
          cachedData = data.stocks;
          console.log(`‚úÖ Loaded ${Object.keys(cachedData).length} cached stocks`);
          console.log(`üìÖ Data version: ${data.dataVersion || 'unknown'}`);
          console.log(`üìÖ Last updated: ${data.lastUpdated}`);
          
          // Test BABA data
          if (cachedData['BABA']) {
            console.log(`üêò BABA marketCap: $${(cachedData['BABA'].marketCap / 1e9).toFixed(1)}B`);
          }
          
          // Show success message
          const successDiv = document.createElement('div');
          successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: rgba(46,213,115,0.9); color: white; padding: 15px 25px; border-radius: 10px; z-index: 10000; font-weight: 600;';
          successDiv.textContent = `‚úÖ Database loaded: ${Object.keys(cachedData).length} stocks`;
          document.body.appendChild(successDiv);
          setTimeout(() => successDiv.remove(), 3000);
          
        } else {
          console.error('‚ùå Database file not found (404)');
          showDatabaseMissingWarning();
        }
      } catch (e) {
        console.error('‚ùå Error loading database:', e);
        showDatabaseMissingWarning();
      }
    });
    
    function showDatabaseMissingWarning() {
      const warning = document.createElement('div');
      warning.style.cssText = 'background: rgba(255,159,67,0.15); border: 2px solid #ff9f43; border-radius: 15px; padding: 30px; margin: 20px 0; text-align: center;';
      warning.innerHTML = `
        <h3 style="color: #ff9f43; margin-bottom: 15px;">‚ö†Ô∏è Database Not Found</h3>
        <p style="font-size: 1.1rem; line-height: 1.8; color: rgba(255,255,255,0.8);">
          The stock database file is missing. To analyze stocks:<br><br>
          <strong>1.</strong> Download <code>fetch-quick-start.py</code><br>
          <strong>2.</strong> Run: <code>python3 fetch-quick-start.py</code> (takes 5 minutes)<br>
          <strong>3.</strong> Upload the generated <code>stock-analysis-data.json</code> to GitHub<br><br>
          <em>You can still type stock symbols and try to analyze them.</em>
        </p>
      `;
      document.querySelector('.search-section').appendChild(warning);
    }
    
    // ==========================================
    // ANALYZE STOCK
    // ==========================================
    
    async function analyzeStock() {
      const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
      
      if (!symbol) {
        showError('Please enter a stock symbol');
        return;
      }
      
      currentSymbol = symbol;
      showLoading(true, 'Loading stock data...');
      hideError();
      
      try {
        let stockData;
        
        // Check cache first
        if (cachedData && cachedData[symbol]) {
          console.log(`üì¶ Using cached data for ${symbol}`);
          stockData = cachedData[symbol];
          showLoading(true, 'Loading from cache...');
          await new Promise(resolve => setTimeout(resolve, 500));
        } else {
          // Show helpful error with instructions
          showLoading(false);
          showError(`
            <strong>${symbol} is not in the database.</strong><br><br>
            
            <strong>To analyze ${symbol}:</strong><br>
            1. Download <code>fetch-quick-start.py</code> or <code>fetch-all-tickers.py</code><br>
            2. Run the script on your computer<br>
            3. Upload the generated <code>stock-analysis-data.json</code> to GitHub<br><br>
            
            <strong>Quick start (5 minutes):</strong><br>
            <code>python3 fetch-quick-start.py</code><br><br>
            
            <strong>Full database (60 minutes, 682+ stocks):</strong><br>
            <code>python3 fetch-all-tickers.py</code><br><br>
            
            The database will include ${symbol} and hundreds of other stocks!
          `);
          return;
        }
        
        if (!stockData) {
          throw new Error(`Could not load data for ${symbol}`);
        }
        
        currentStock = stockData;
        
        // Display all sections
        displayOverview(stockData);
        displayDCF(stockData);
        displayGrowth(stockData);
        displayDebt(stockData);
        displayROE(stockData);
        displayCharts(stockData);
        
        document.getElementById('mainContent').style.display = 'block';
        showLoading(false);
        document.getElementById('mainContent').scrollIntoView({ behavior: 'smooth' });
        
      } catch (e) {
        showLoading(false);
        showError(e.message || 'Failed to analyze stock. Please check the symbol and try again.');
        console.error(e);
      }
    }
    
    // ==========================================
    // FETCH STOCK DATA (ON-DEMAND)
    // ==========================================
    
    async function fetchStockData(symbol) {
      // This would call a serverless function or proxy
      // For now, show that it's not cached
      throw new Error(`${symbol} not in cache. Please run fetch-professional-analysis.py to add this stock.`);
    }
    
    // ==========================================
    // DISPLAY FUNCTIONS
    // ==========================================
    
    function displayOverview(stock) {
      document.getElementById('stockSymbol').textContent = stock.symbol;
      document.getElementById('stockName').textContent = stock.name;
      document.getElementById('stockInfo').textContent = 
        `${stock.sector || 'N/A'} ‚Ä¢ ${stock.industry || 'N/A'} ‚Ä¢ ${stock.exchange}`;
      
      document.getElementById('currentPrice').textContent = `$${stock.price.toFixed(2)}`;
      
      const changeClass = stock.change >= 0 ? 'positive' : 'negative';
      const changeSymbol = stock.change >= 0 ? '‚ñ≤' : '‚ñº';
      document.getElementById('priceChange').innerHTML = `
        <span class="${changeClass}">
          ${changeSymbol} $${Math.abs(stock.change).toFixed(2)} (${Math.abs(stock.changePercent).toFixed(2)}%)
        </span>
      `;
      
      const metrics = [
        { label: 'Market Cap', value: formatLarge(stock.marketCap) },
        { label: 'P/E Ratio', value: stock.pe },
        { label: 'EPS', value: stock.eps },
        { label: 'Revenue', value: formatLarge(stock.revenue) },
        { label: 'Profit Margin', value: stock.profitMargin },
        { label: 'ROE', value: stock.roe },
        { label: 'Debt/Equity', value: stock.debtToEquity },
        { label: 'Free Cash Flow', value: formatLarge(stock.freeCashflow) }
      ];
      
      document.getElementById('metricsGrid').innerHTML = metrics.map(m => `
        <div class="metric-box">
          <div class="metric-label">${m.label}</div>
          <div class="metric-value">${m.value}</div>
        </div>
      `).join('');
    }
    
    function displayDCF(stock) {
      const fcf = stock.freeCashflow || 0;
      const growthRate = 0.06; // Assume 6% growth
      const wacc = 0.095; // 9.5% WACC
      const terminalGrowth = 0.03; // 3% terminal
      
      // Project 5 years
      let projections = [];
      let pv = 0;
      for (let year = 1; year <= 5; year++) {
        const fcfYear = fcf * Math.pow(1 + growthRate, year);
        const pvFactor = Math.pow(1 + wacc, year);
        const pvYear = fcfYear / pvFactor;
        pv += pvYear;
        projections.push({ year, fcf: fcfYear, pv: pvYear });
      }
      
      // Terminal value
      const terminalFCF = fcf * Math.pow(1 + growthRate, 6);
      const terminalValue = (terminalFCF * (1 + terminalGrowth)) / (wacc - terminalGrowth);
      const pvTerminal = terminalValue / Math.pow(1 + wacc, 5);
      
      const enterpriseValue = pv + pvTerminal;
      const netDebt = stock.netDebt || 0;
      const equityValue = enterpriseValue - netDebt;
      const sharesOut = stock.sharesOutstanding || 1;
      const fairValue = equityValue / sharesOut;
      const upside = ((fairValue - stock.price) / stock.price) * 100;
      
      document.getElementById('dcfContent').innerHTML = `
        <div class="highlight-box">
          <h3 style="color: #2ed573; margin-bottom: 15px;">üí∞ Intrinsic Value Estimate</h3>
          <div style="font-size: 2rem; font-weight: 700; color: #667eea; margin: 10px 0;">
            $${fairValue.toFixed(2)} per share
          </div>
          <div style="font-size: 1.2rem; margin-top: 10px;">
            Current Price: $${stock.price.toFixed(2)} | 
            <span class="${upside >= 0 ? 'positive' : 'negative'}">
              ${upside >= 0 ? 'Upside' : 'Downside'}: ${Math.abs(upside).toFixed(1)}%
            </span>
          </div>
        </div>
        
        <h4 style="color: #a8b2d1; margin: 25px 0 15px;">Assumptions</h4>
        <ul style="line-height: 1.8; color: rgba(255,255,255,0.8);">
          <li>Current Free Cash Flow: ${formatLarge(fcf)}</li>
          <li>Growth Rate: ${(growthRate * 100).toFixed(1)}% per year</li>
          <li>Terminal Growth: ${(terminalGrowth * 100).toFixed(1)}%</li>
          <li>WACC (Discount Rate): ${(wacc * 100).toFixed(1)}%</li>
        </ul>
        
        <h4 style="color: #a8b2d1; margin: 25px 0 15px;">5-Year Projection</h4>
        <table class="data-table">
          <tr>
            <th>Year</th>
            <th>Free Cash Flow</th>
            <th>Present Value</th>
          </tr>
          ${projections.map(p => `
            <tr>
              <td>Year ${p.year}</td>
              <td>${formatLarge(p.fcf)}</td>
              <td>${formatLarge(p.pv)}</td>
            </tr>
          `).join('')}
          <tr style="background: rgba(102, 126, 234, 0.15); font-weight: 700;">
            <td>Terminal Value</td>
            <td>${formatLarge(terminalValue)}</td>
            <td>${formatLarge(pvTerminal)}</td>
          </tr>
        </table>
        
        <h4 style="color: #a8b2d1; margin: 25px 0 15px;">Valuation Summary</h4>
        <table class="data-table">
          <tr><td>PV of 5-Year Cash Flows</td><td>${formatLarge(pv)}</td></tr>
          <tr><td>PV of Terminal Value</td><td>${formatLarge(pvTerminal)}</td></tr>
          <tr><td>Enterprise Value</td><td>${formatLarge(enterpriseValue)}</td></tr>
          <tr><td>Less: Net Debt</td><td>${formatLarge(netDebt)}</td></tr>
          <tr style="background: rgba(102, 126, 234, 0.15); font-weight: 700;">
            <td>Equity Value</td><td>${formatLarge(equityValue)}</td>
          </tr>
          <tr style="background: rgba(46, 213, 115, 0.15); font-weight: 700;">
            <td>Fair Value Per Share</td><td>$${fairValue.toFixed(2)}</td>
          </tr>
        </table>
      `;
    }
    
    function displayGrowth(stock) {
      const hasHistory = stock.incomeStatementHistory && stock.incomeStatementHistory.length > 1;
      
      let growthHTML = `
        <h4 style="color: #a8b2d1; margin-bottom: 15px;">Current Metrics</h4>
        <table class="data-table">
          <tr><td>Revenue (TTM)</td><td>${formatLarge(stock.revenue)}</td></tr>
          <tr><td>Revenue Growth</td><td>${stock.revenueGrowth}</td></tr>
          <tr><td>Earnings Growth</td><td>${stock.earningsGrowth}</td></tr>
          <tr><td>Gross Margin</td><td>${stock.grossMargin}</td></tr>
          <tr><td>Operating Margin</td><td>${stock.operatingMargin}</td></tr>
          <tr><td>Net Profit Margin</td><td>${stock.profitMargin}</td></tr>
          <tr><td>EBITDA Margin</td><td>${stock.ebitdaMargin}</td></tr>
        </table>
      `;
      
      if (hasHistory) {
        const revenues = stock.incomeStatementHistory.map(h => h.revenue).reverse();
        const years = stock.incomeStatementHistory.length;
        const cagr = years > 1 ? 
          (Math.pow(revenues[revenues.length - 1] / revenues[0], 1 / (years - 1)) - 1) * 100 : 0;
        
        growthHTML += `
          <div class="highlight-box" style="margin-top: 25px;">
            <h4 style="color: #2ed573; margin-bottom: 10px;">üìä ${years}-Year Revenue CAGR</h4>
            <div style="font-size: 2.5rem; font-weight: 700; color: #667eea;">
              ${cagr.toFixed(1)}%
            </div>
          </div>
          
          <h4 style="color: #a8b2d1; margin: 25px 0 15px;">Historical Performance</h4>
          <table class="data-table">
            <tr><th>Year</th><th>Revenue</th><th>Net Income</th><th>Margins</th></tr>
            ${stock.incomeStatementHistory.slice().reverse().map(h => `
              <tr>
                <td>${h.date}</td>
                <td>${formatLarge(h.revenue)}</td>
                <td>${formatLarge(h.netIncome)}</td>
                <td>${h.netIncome && h.revenue ? ((h.netIncome/h.revenue)*100).toFixed(1) + '%' : 'N/A'}</td>
              </tr>
            `).join('')}
          </table>
        `;
      }
      
      document.getElementById('growthContent').innerHTML = growthHTML;
    }
    
    function displayDebt(stock) {
      const totalDebt = stock.totalDebt || 0;
      const totalCash = stock.totalCash || 0;
      const netDebt = totalDebt - totalCash;
      const equity = stock.totalEquity || 1;
      const debtToEquity = totalDebt / equity;
      const ebitda = stock.ebitda || 1;
      const netDebtToEbitda = netDebt / ebitda;
      
      let creditRating = 'N/A';
      if (netDebtToEbitda < 1) creditRating = 'AAA (Excellent)';
      else if (netDebtToEbitda < 2) creditRating = 'AA (Very Good)';
      else if (netDebtToEbitda < 3) creditRating = 'A (Good)';
      else if (netDebtToEbitda < 4) creditRating = 'BBB (Adequate)';
      else if (netDebtToEbitda < 5) creditRating = 'BB (Moderate)';
      else creditRating = 'B (High Risk)';
      
      const boxClass = netDebt < 0 ? 'highlight-box' : (netDebtToEbitda > 4 ? 'warning-box' : '');
      
      document.getElementById('debtContent').innerHTML = `
        <div class="${boxClass}">
          <h3 style="margin-bottom: 15px;">${netDebt < 0 ? 'üí™ Net Cash Position' : 'üí≥ Debt Position'}</h3>
          <div style="font-size: 2rem; font-weight: 700; margin: 10px 0;">
            ${netDebt < 0 ? 'Net Cash: ' : 'Net Debt: '}${formatLarge(Math.abs(netDebt))}
          </div>
          <div style="font-size: 1.1rem; margin-top: 10px;">
            Estimated Credit Quality: <strong>${creditRating}</strong>
          </div>
        </div>
        
        <h4 style="color: #a8b2d1; margin: 25px 0 15px;">Debt Components</h4>
        <table class="data-table">
          <tr><td>Total Debt</td><td>${formatLarge(totalDebt)}</td></tr>
          <tr><td>Total Cash</td><td>${formatLarge(totalCash)}</td></tr>
          <tr style="background: rgba(102, 126, 234, 0.15); font-weight: 700;">
            <td>Net Debt (Debt - Cash)</td><td>${formatLarge(netDebt)}</td>
          </tr>
        </table>
        
        <h4 style="color: #a8b2d1; margin: 25px 0 15px;">Leverage Ratios</h4>
        <table class="data-table">
          <tr><td>Debt-to-Equity</td><td>${debtToEquity.toFixed(2)}x</td></tr>
          <tr><td>Debt-to-Assets</td><td>${stock.debtToAssets ? stock.debtToAssets.toFixed(2) + 'x' : 'N/A'}</td></tr>
          <tr><td>Net Debt-to-EBITDA</td><td>${netDebtToEbitda.toFixed(2)}x</td></tr>
          <tr><td>Interest Coverage</td><td>${stock.interestCoverage || 'N/A'}</td></tr>
          <tr><td>Current Ratio</td><td>${stock.currentRatio}</td></tr>
          <tr><td>Quick Ratio</td><td>${stock.quickRatio}</td></tr>
        </table>
        
        <h4 style="color: #a8b2d1; margin: 25px 0 15px;">Analysis</h4>
        <p style="line-height: 1.8; color: rgba(255,255,255,0.8);">
          ${netDebt < 0 ? 
            `<strong style="color: #2ed573;">Fortress Balance Sheet:</strong> The company has more cash than debt, providing significant financial flexibility for investments, acquisitions, or returning capital to shareholders. This is a very strong position.` :
            netDebtToEbitda > 4 ?
            `<strong style="color: #ff6b6b;">High Leverage:</strong> The company carries significant debt relative to earnings. Net debt is ${netDebtToEbitda.toFixed(1)}x EBITDA, which may limit financial flexibility and increase risk during downturns.` :
            `<strong style="color: #26d0ce;">Moderate Leverage:</strong> The company maintains reasonable debt levels at ${netDebtToEbitda.toFixed(1)}x EBITDA. This provides some financial flexibility while utilizing leverage for growth.`
          }
        </p>
      `;
    }
    
    function displayROE(stock) {
      const roe = parseFloat(stock.roe) || 0;
      const profitMargin = parseFloat(stock.profitMargin) || 0;
      const revenue = stock.revenue || 1;
      const assets = stock.totalAssets || revenue;
      const equity = stock.totalEquity || (assets / 2);
      
      const assetTurnover = revenue / assets;
      const equityMultiplier = assets / equity;
      
      const calculatedROE = (profitMargin / 100) * assetTurnover * equityMultiplier * 100;
      
      document.getElementById('roeContent').innerHTML = `
        <div class="highlight-box">
          <h3 style="color: #2ed573; margin-bottom: 15px;">Return on Equity (ROE)</h3>
          <div style="font-size: 3rem; font-weight: 700; color: #667eea; margin: 10px 0;">
            ${roe.toFixed(1)}%
          </div>
        </div>
        
        <h4 style="color: #a8b2d1; margin: 25px 0 15px;">DuPont 3-Factor Model</h4>
        <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 10px; margin: 15px 0;">
          <div style="font-size: 1.2rem; text-align: center; line-height: 2;">
            <strong>ROE</strong> = 
            <span style="color: #2ed573;">Net Margin</span> √ó 
            <span style="color: #26d0ce;">Asset Turnover</span> √ó 
            <span style="color: #667eea;">Equity Multiplier</span>
          </div>
          <div style="font-size: 1.4rem; text-align: center; margin-top: 15px; font-weight: 700;">
            ${roe.toFixed(1)}% = 
            <span style="color: #2ed573;">${profitMargin.toFixed(1)}%</span> √ó 
            <span style="color: #26d0ce;">${assetTurnover.toFixed(2)}</span> √ó 
            <span style="color: #667eea;">${equityMultiplier.toFixed(2)}</span>
          </div>
        </div>
        
        <h4 style="color: #a8b2d1; margin: 25px 0 15px;">Component Analysis</h4>
        <table class="data-table">
          <tr>
            <td><strong style="color: #2ed573;">Net Profit Margin</strong></td>
            <td>${profitMargin.toFixed(2)}%</td>
            <td>Profitability: How much profit per dollar of sales</td>
          </tr>
          <tr>
            <td><strong style="color: #26d0ce;">Asset Turnover</strong></td>
            <td>${assetTurnover.toFixed(2)}x</td>
            <td>Efficiency: How well assets generate revenue</td>
          </tr>
          <tr>
            <td><strong style="color: #667eea;">Equity Multiplier</strong></td>
            <td>${equityMultiplier.toFixed(2)}x</td>
            <td>Leverage: Assets per dollar of equity</td>
          </tr>
        </table>
        
        <h4 style="color: #a8b2d1; margin: 25px 0 15px;">Interpretation</h4>
        <p style="line-height: 1.8; color: rgba(255,255,255,0.8);">
          ${roe > 15 ?
            `<strong style="color: #2ed573;">Excellent Returns:</strong> ROE of ${roe.toFixed(1)}% is strong, indicating efficient use of shareholder capital.` :
            roe > 10 ?
            `<strong style="color: #26d0ce;">Good Returns:</strong> ROE of ${roe.toFixed(1)}% is reasonable and competitive.` :
            roe > 5 ?
            `<strong style="color: #ff9f43;">Moderate Returns:</strong> ROE of ${roe.toFixed(1)}% is below average. Consider if this is temporary or structural.` :
            `<strong style="color: #ff6b6b;">Low Returns:</strong> ROE of ${roe.toFixed(1)}% suggests capital is not being used efficiently.`
          }
          <br><br>
          <strong>Primary Driver:</strong> 
          ${profitMargin > 15 ?
            `High profitability (${profitMargin.toFixed(1)}% margin) is the main contributor.` :
            equityMultiplier > 3 ?
            `Financial leverage (${equityMultiplier.toFixed(1)}x multiplier) is boosting returns.` :
            `Operational efficiency (${assetTurnover.toFixed(2)}x turnover) drives the ROE.`
          }
        </p>
      `;
    }
    
    function displayCharts(stock) {
      // Create chart placeholders
      document.getElementById('chartsContent').innerHTML = `
        <div class="chart-card">
          <div class="chart-title">Revenue & Net Income Trend</div>
          <canvas id="revenueChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Margin Evolution</div>
          <canvas id="marginChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Debt Profile</div>
          <canvas id="debtChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Cash Flow Analysis</div>
          <canvas id="cashflowChart"></canvas>
        </div>
      `;
      
      // Revenue Chart
      if (stock.incomeStatementHistory && stock.incomeStatementHistory.length > 0) {
        const history = stock.incomeStatementHistory.slice().reverse();
        new Chart(document.getElementById('revenueChart'), {
          type: 'bar',
          data: {
            labels: history.map(h => h.date),
            datasets: [
              {
                label: 'Revenue',
                data: history.map(h => h.revenue / 1e9),
                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                borderColor: '#667eea',
                borderWidth: 2
              },
              {
                label: 'Net Income',
                data: history.map(h => h.netIncome / 1e9),
                backgroundColor: 'rgba(46, 213, 115, 0.6)',
                borderColor: '#2ed573',
                borderWidth: 2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { color: '#a8b2d1' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                title: { display: true, text: 'Billions ($)', color: '#a8b2d1' }
              },
              x: {
                ticks: { color: '#a8b2d1' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            },
            plugins: {
              legend: { labels: { color: '#a8b2d1' } }
            }
          }
        });
        
        // Margin Chart
        const margins = history.map(h => ({
          date: h.date,
          gross: h.grossProfit && h.revenue ? (h.grossProfit / h.revenue) * 100 : null,
          operating: h.operatingIncome && h.revenue ? (h.operatingIncome / h.revenue) * 100 : null,
          net: h.netIncome && h.revenue ? (h.netIncome / h.revenue) * 100 : null
        }));
        
        new Chart(document.getElementById('marginChart'), {
          type: 'line',
          data: {
            labels: margins.map(m => m.date),
            datasets: [
              {
                label: 'Gross Margin',
                data: margins.map(m => m.gross),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                fill: true,
                tension: 0.4
              },
              {
                label: 'Operating Margin',
                data: margins.map(m => m.operating),
                borderColor: '#26d0ce',
                backgroundColor: 'rgba(38, 208, 206, 0.1)',
                fill: true,
                tension: 0.4
              },
              {
                label: 'Net Margin',
                data: margins.map(m => m.net),
                borderColor: '#2ed573',
                backgroundColor: 'rgba(46, 213, 115, 0.1)',
                fill: true,
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                ticks: { 
                  color: '#a8b2d1',
                  callback: value => value + '%'
                },
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                title: { display: true, text: 'Margin (%)', color: '#a8b2d1' }
              },
              x: {
                ticks: { color: '#a8b2d1' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            },
            plugins: {
              legend: { labels: { color: '#a8b2d1' } }
            }
          }
        });
      }
      
      // Debt Chart
      if (stock.balanceSheetHistory && stock.balanceSheetHistory.length > 0) {
        const balanceHistory = stock.balanceSheetHistory.slice().reverse();
        new Chart(document.getElementById('debtChart'), {
          type: 'line',
          data: {
            labels: balanceHistory.map(h => h.date),
            datasets: [
              {
                label: 'Total Debt',
                data: balanceHistory.map(h => h.totalDebt / 1e9),
                borderColor: '#ff6b6b',
                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                fill: true,
                tension: 0.4
              },
              {
                label: 'Cash',
                data: balanceHistory.map(h => h.cash / 1e9),
                borderColor: '#2ed573',
                backgroundColor: 'rgba(46, 213, 115, 0.1)',
                fill: true,
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                ticks: { color: '#a8b2d1' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                title: { display: true, text: 'Billions ($)', color: '#a8b2d1' }
              },
              x: {
                ticks: { color: '#a8b2d1' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            },
            plugins: {
              legend: { labels: { color: '#a8b2d1' } }
            }
          }
        });
      }
      
      // Cash Flow Chart
      if (stock.cashFlowHistory && stock.cashFlowHistory.length > 0) {
        const cfHistory = stock.cashFlowHistory.slice().reverse();
        new Chart(document.getElementById('cashflowChart'), {
          type: 'bar',
          data: {
            labels: cfHistory.map(h => h.date),
            datasets: [
              {
                label: 'Operating CF',
                data: cfHistory.map(h => h.operatingCashFlow / 1e9),
                backgroundColor: 'rgba(46, 213, 115, 0.6)',
                borderColor: '#2ed573',
                borderWidth: 2
              },
              {
                label: 'Investing CF',
                data: cfHistory.map(h => h.investingCashFlow / 1e9),
                backgroundColor: 'rgba(255, 159, 67, 0.6)',
                borderColor: '#ff9f43',
                borderWidth: 2
              },
              {
                label: 'Financing CF',
                data: cfHistory.map(h => h.financingCashFlow / 1e9),
                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                borderColor: '#667eea',
                borderWidth: 2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                ticks: { color: '#a8b2d1' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                title: { display: true, text: 'Billions ($)', color: '#a8b2d1' }
              },
              x: {
                ticks: { color: '#a8b2d1' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            },
            plugins: {
              legend: { labels: { color: '#a8b2d1' } }
            }
          }
        });
      }
    }
    
    // ==========================================
    // AI ANALYSIS
    // ==========================================
    
    async function generateAIAnalysis() {
      if (!currentStock) return;
      
      const btn = document.getElementById('aiBtn');
      const content = document.getElementById('aiAnalysisContent');
      
      // Show helpful message instead of trying to call API
      content.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(46, 213, 115, 0.05)); padding: 30px; border-radius: 15px; border-left: 4px solid #667eea;">
          <h3 style="color: #667eea; margin-bottom: 20px;">ü§ñ AI Analysis Coming Soon</h3>
          
          <p style="line-height: 1.8; margin-bottom: 20px;">
            The AI analysis feature uses Claude's API, which requires server-side integration. 
            For now, you can view comprehensive financial analysis in the other tabs:
          </p>
          
          <ul style="line-height: 2; margin-left: 25px; margin-bottom: 20px;">
            <li><strong>üí∞ DCF Valuation:</strong> Intrinsic value calculation with 5-year projections</li>
            <li><strong>üìà Growth & Margins:</strong> Revenue trends and profitability analysis</li>
            <li><strong>üí≥ Debt Profile:</strong> Balance sheet strength and credit quality</li>
            <li><strong>üéØ ROE Analysis:</strong> DuPont breakdown of return drivers</li>
            <li><strong>üìä Charts:</strong> Visual trends across all metrics</li>
          </ul>
          
          <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-top: 25px;">
            <h4 style="color: #2ed573; margin-bottom: 15px;">Manual Analysis for ${currentStock.symbol}:</h4>
            
            <p><strong>Valuation:</strong> ${currentStock.pe !== 'N/A' ? 'P/E ratio of ' + currentStock.pe : 'Limited valuation data available'}</p>
            
            <p><strong>Growth:</strong> ${currentStock.revenueGrowth !== 'N/A' ? 'Revenue growing at ' + currentStock.revenueGrowth + ' YoY' : 'Revenue growth data pending'}</p>
            
            <p><strong>Profitability:</strong> ${currentStock.profitMargin !== 'N/A' ? 'Operating with ' + currentStock.profitMargin + ' profit margin' : 'Margin data not available'}</p>
            
            <p><strong>Financial Health:</strong> ${currentStock.debtToEquity !== 'N/A' ? 'Debt-to-Equity of ' + currentStock.debtToEquity : 'Leverage metrics pending'}</p>
            
            <p><strong>Returns:</strong> ${currentStock.roe !== 'N/A' ? 'ROE of ' + currentStock.roe : 'Return metrics not available'}</p>
          </div>
          
          <p style="margin-top: 25px; color: rgba(255,255,255,0.6); font-size: 0.95rem;">
            üí° <em>Tip: Check the other tabs for detailed financial models and interactive charts!</em>
          </p>
        </div>
      `;
      
      btn.textContent = '‚úÖ View Other Analysis Tabs';
      btn.onclick = () => switchTab('dcf');
    }
    
    // ==========================================
    // UTILITIES
    // ==========================================
    
    function formatLarge(num) {
      if (!num && num !== 0) return 'N/A';
      if (num >= 1e12) return `$${(num / 1e12).toFixed(2)}T`;
      if (num >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
      if (num >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
      if (num >= 1e3) return `$${(num / 1e3).toFixed(2)}K`;
      return `$${num.toLocaleString()}`;
    }
    
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }
    
    function showLoading(show, text = 'Loading...') {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
      if (text) document.getElementById('loadingText').textContent = text;
    }
    
    function showError(msg) {
      document.getElementById('errorBox').innerHTML = 
        `<div class="error-box"><strong>‚ùå Error:</strong> ${msg}</div>`;
    }
    
    function hideError() {
      document.getElementById('errorBox').innerHTML = '';
    }
  </script>
</body>
</html>
